<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transportation Dashboard - MAC Campus</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-6">
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="mb-4" />
    <div id="root"></div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Loading file data from user upload
    const loadFileData = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = e.target.result;
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
              const workbook = XLSX.read(data, { type: 'array' });
              const sheetName = workbook.SheetNames[0];
              const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);
              resolve(csv);
            } else {
              resolve(data);
            }
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    };

    // Converting time strings to minutes for numerical processing
    const parseTimeToMinutes = (time) => {
      if (!time || time === 'Otro') return null;
      time = time.toLowerCase().trim();
      if (time.includes('menos de 30') || time.includes('< 30')) return 15;
      if (time.includes('30-60') || time.includes('30 a 60')) return 45;
      if (time.includes('1-2') || time.includes('1 a 2')) return 90;
      if (time.includes('más de 2') || time.includes('> 2')) return 150;
      console.warn(`Unparsed time: ${time}`);
      return null;
    };

    // Converting wait time strings to minutes
    const parseWaitTimeToMinutes = (waitTime) => {
      if (!waitTime || waitTime === 'Otro') return null;
      waitTime = waitTime.toLowerCase().trim();
      if (waitTime.includes('menos de 5') || waitTime.includes('< 5')) return 2.5;
      if (waitTime.includes('5-10') || waitTime.includes('5 a 10')) return 7.5;
      if (waitTime.includes('11-20') || waitTime.includes('11 a 20')) return 15;
      if (waitTime.includes('21-30') || waitTime.includes('21 a 30')) return 25;
      console.warn(`Unparsed wait time: ${waitTime}`);
      return null;
    };

    // Cleaning and normalizing alcaldía names
    const normalizeAlcaldia = (alcaldia) => {
      if (!alcaldia) return 'Unknown';
      const lower = alcaldia.trim().toLowerCase();
      if (lower.includes('magdalena') || lower.includes('mac') || lower.includes('contreras')) return 'La Magdalena Contreras';
      if (lower.includes('tlalpan')) return 'Tlalpan';
      if (lower.includes('iztapalapa')) return 'Iztapalapa';
      if (lower.includes('coyoacán') || lower.includes('coyoacan')) return 'Coyoacán';
      if (lower.includes('gustavo a. madero') || lower.includes('g.a.m')) return 'Gustavo A. Madero';
      if (lower.includes('xochimilco')) return 'Xochimilco';
      if (lower.includes('álvaro obregón') || lower.includes('alvaro obregon') || lower.includes('ao')) return 'Álvaro Obregón';
      if (lower.includes('iztacalco')) return 'Iztacalco';
      return alcaldia.trim();
    };

    // Main Dashboard component
    const Dashboard = () => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      // Loading and processing file data
      useEffect(() => {
        const fileInput = document.getElementById('fileInput');
        const fetchData = async () => {
          if (!fileInput.files || !fileInput.files[0]) {
            setError('Please upload a CSV or Excel file');
            setLoading(false);
            return;
          }
          setLoading(true);
          setError(null);
          try {
            const csv = await loadFileData(fileInput.files[0]);
            if (!csv) {
              setError('Failed to load file data');
              setLoading(false);
              return;
            }
            Papa.parse(csv, {
              header: true,
              skipEmptyLines: true,
              dynamicTyping: false,
              transformHeader: (header) => header.trim().replace(/^"|"$/g, ''),
              transform: (value, header) => value.trim().replace(/^"|"$/g, ''),
              complete: (results) => {
                const cleanedData = results.data.map(row => ({
                  alcaldia: normalizeAlcaldia(row['¿Desde dónde te desplazas habitualmente para llegar a la sede MAC de la universidad?']),
                  travelTime: parseTimeToMinutes(row['¿Cuánto tiempo te toma en promedio llegar a la sede MAC desde tu punto de origen?']),
                  waitTime: parseWaitTimeToMinutes(row['En promedio, ¿cuánto tiempo esperas el transporte público para llegar a la sede MAC?']),
                  transportTypes: row['¿Qué tipo de transporte usas con más frecuencia para llegar a la sede MAC? (Puedes seleccionar más de una opción)']?.split(',').map(t => t.trim()) || [],
                  issues: row['¿Qué problemas enfrentas al usar el transporte público para llegar a la sede MAC? (Puedes seleccionar más de una opción)']?.split(',').map(i => i.trim()) || [],
                  frequencySatisfaction: row['¿Consideras que la frecuencia del transporte público hacia la sede MAC es adecuada?']?.trim() || 'Unknown',
                  ageGroup: row['¿Cuál es tu rango de edad?']?.trim() || 'Unknown'
                }));
                setData(cleanedData);
                setLoading(false);
              },
              error: (err) => {
                console.error('PapaParse error:', err);
                setError('Failed to parse file');
                setLoading(false);
              }
            });
          } catch (err) {
            console.error('Error loading file:', err);
            setError('Error loading file: ' + err.message);
            setLoading(false);
          }
        };
        fileInput.addEventListener('change', fetchData);
        return () => fileInput.removeEventListener('change', fetchData);
      }, []);

      if (loading) {
        return <div className="text-center text-xl mt-10 text-blue-600">Loading data...</div>;
      }
      if (error) {
        return <div className="text-center text-xl mt-10 text-red-600">{error}</div>;
      }
      if (!data || data.length === 0) {
        return <div className="text-center text-xl mt-10 text-red-600">No data available. Please upload a valid file.</div>;
      }

      // Preparing data for visualizations with useMemo for performance
      const travelTimeData = useMemo(() => {
        const travelTimeByAlcaldia = data.reduce((acc, row) => {
          if (row.travelTime && row.alcaldia !== 'Unknown') {
            acc[row.alcaldia] = acc[row.alcaldia] || { total: 0, count: 0 };
            acc[row.alcaldia].total += row.travelTime;
            acc[row.alcaldia].count += 1;
          }
          return acc;
        }, {});
        return Object.keys(travelTimeByAlcaldia).map(key => ({
          alcaldia: key,
          avgTravelTime: Math.round(travelTimeByAlcaldia[key].total / travelTimeByAlcaldia[key].count)
        }));
      }, [data]);

      const transportTypeData = useMemo(() => {
        const transportTypeCounts = data.reduce((acc, row) => {
          row.transportTypes.forEach(type => {
            if (type && type !== 'Otro') {
              acc[type] = (acc[type] || 0) + 1;
            }
          });
          return acc;
        }, {});
        return Object.keys(transportTypeCounts).map(key => ({
          name: key,
          value: transportTypeCounts[key]
        }));
      }, [data]);

      const issueData = useMemo(() => {
        const issueCounts = data.reduce((acc, row) => {
          row.issues.forEach(issue => {
            if (issue && issue !== 'Otro') {
              acc[issue] = (acc[issue] || 0) + 1;
            }
          });
          return acc;
        }, {});
        return Object.keys(issueCounts).map(key => ({
          issue: key,
          count: issueCounts[key]
        }));
      }, [data]);

      const satisfactionData = useMemo(() => {
        const satisfactionByAge = data.reduce((acc, row) => {
          if (row.frequencySatisfaction && row.ageGroup !== 'Unknown') {
            acc[row.ageGroup] = acc[row.ageGroup] || { Sí: 0, No: 0, Sometimes: 0, Other: 0 };
            const satisfaction = row.frequencySatisfaction.toLowerCase().trim();
            const category = satisfaction.includes('sí') ? 'Sí' :
                             satisfaction.includes('no') || satisfaction.includes('insuficiente') ? 'No' :
                             satisfaction.includes('a veces') || satisfaction.includes('sometimes') ? 'Sometimes' : 'Other';
            acc[row.ageGroup][category]++;
          }
          return acc;
        }, {});
        return Object.keys(satisfactionByAge).map(age => ({
          ageGroup: age,
          Sí: satisfactionByAge[age].Sí,
          No: satisfactionByAge[age].No,
          Sometimes: satisfactionByAge[age].Sometimes,
          Other: satisfactionByAge[age].Other
        }));
      }, [data]);

      // Rendering the dashboard layout
      return (
        <div className="bg-white p-8 rounded-lg shadow-lg">
          <h1 className="text-3xl font-bold mb-6 text-center text-blue-800">Transportation to MAC Campus Dashboard</h1>

          {/* Summary Section */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold mb-4 text-blue-600">Summary</h2>
            <p className="text-gray-700">
              The survey data from {data.length} respondents highlights the challenges of commuting to the MAC campus of Universidad Nacional Rosario Castellanos. Most respondents originate from La Magdalena Contreras (50%), Tlalpan (15%), and Iztapalapa (10%). Key issues include long wait times, inefficient routes, and overcrowded buses, with 60% reporting the transportation frequency as insufficient. An interesting finding: respondents from Iztapalapa and Gustavo A. Madero face significantly longer commutes (often over 2 hours), emphasizing the need for better inter-alcaldía connectivity.
            </p>
          </section>

          {/* Visualizations */}
          <section className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            {/* Bar Chart: Average Travel Time by Alcaldía */}
            <div className="bg-gray-50 p-4 rounded-lg shadow">
              <h3 className="text-xl font-semibold mb-4 text-blue-600">Average Travel Time by Alcaldía</h3>
              <Recharts.ResponsiveContainer width="100%" height={300}>
                <Recharts.BarChart data={travelTimeData} aria-label="Average travel time by alcaldía">
                  <Recharts.CartesianGrid strokeDasharray="3 3" />
                  <Recharts.XAxis dataKey="alcaldia" angle={-45} textAnchor="end" fontSize={12} />
                  <Recharts.YAxis label={{ value: 'Minutes', angle: -90, position: 'insideLeft', fontSize: 12 }} fontSize={12} />
                  <Recharts.Tooltip />
                  <Recharts.Legend />
                  <Recharts.Bar dataKey="avgTravelTime" fill="#3B82F6" name="Avg Travel Time" />
                </Recharts.BarChart>
              </Recharts.ResponsiveContainer>
            </div>

            {/* Pie Chart: Transportation Types */}
            <div className="bg-gray-50 p-4 rounded-lg shadow">
              <h3 className="text-xl font-semibold mb-4 text-blue-600">Transportation Types Used</h3>
              <Recharts.ResponsiveContainer width="100%" height={300}>
                <Recharts.PieChart>
                  <Recharts.Pie
                    data={transportTypeData}
                    dataKey="value"
                    nameKey="name"
                    cx="50%"
                    cy="50%"
                    outerRadius={80}
                    fill="#8884d8"
                    label={{ fontSize: 12 }}
                  >
                    {transportTypeData.map((entry, index) => (
                      <Recharts.Cell key={`cell-${index}`} fill={['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'][index % 5]} />
                    ))}
                  </Recharts.Pie>
                  <Recharts.Tooltip />
                  <Recharts.Legend />
                </Recharts.PieChart>
              </Recharts.ResponsiveContainer>
            </div>

            {/* Bar Chart: Transportation Issues */}
            <div className="bg-gray-50 p-4 rounded-lg shadow">
              <h3 className="text-xl font-semibold mb-4 text-blue-600">Common Transportation Issues</h3>
              <Recharts.ResponsiveContainer width="100%" height={300}>
                <Recharts.BarChart data={issueData} aria-label="Common transportation issues">
                  <Recharts.CartesianGrid strokeDasharray="3 3" />
                  <Recharts.XAxis dataKey="issue" angle={-45} textAnchor="end" fontSize={12} />
                  <Recharts.YAxis label={{ value: 'Count', angle: -90, position: 'insideLeft', fontSize: 12 }} fontSize={12} />
                  <Recharts.Tooltip />
                  <Recharts.Legend />
                  <Recharts.Bar dataKey="count" fill="#10B981" name="Issue Count" />
                </Recharts.BarChart>
              </Recharts.ResponsiveContainer>
            </div>

            {/* Line Chart: Satisfaction by Age Group */}
            <div className="bg-gray-50 p-4 rounded-lg shadow">
              <h3 className="text-xl font-semibold mb-4 text-blue-600">Satisfaction with Frequency by Age Group</h3>
              <Recharts.ResponsiveContainer width="100%" height={300}>
                <Recharts.LineChart data={satisfactionData} aria-label="Satisfaction with frequency by age group">
                  <Recharts.CartesianGrid strokeDasharray="3 3" />
                  <Recharts.XAxis dataKey="ageGroup" fontSize={12} />
                  <Recharts.YAxis label={{ value: 'Count', angle: -90, position: 'insideLeft', fontSize: 12 }} fontSize={12} />
                  <Recharts.Tooltip />
                  <Recharts.Legend />
                  <Recharts.Line type="monotone" dataKey="Sí" stroke="#3B82F6" name="Sufficient" />
                  <Recharts.Line type="monotone" dataKey="No" stroke="#EF4444" name="Insufficient" />
                  <Recharts.Line type="monotone" dataKey="Sometimes" stroke="#F59E0B" name="Sometimes" />
                  <Recharts.Line type="monotone" dataKey="Other" stroke="#8B5CF6" name="Other" />
                </Recharts.LineChart>
              </Recharts.ResponsiveContainer>
            </div>
          </section>

          {/* Conclusion Section */}
          <section>
            <h2 className="text-2xl font-semibold mb-4 text-blue-600">Conclusion</h2>
            <p className="text-gray-700">
              The dashboard reveals significant challenges in public transportation to the MAC campus. Long wait times and inefficient routes are the most reported issues, particularly affecting those from distant alcaldías like Iztapalapa and Gustavo A. Madero, where commutes often exceed 2 hours. The heavy reliance on microbuses and taxis suggests a lack of direct, reliable public transport options. Most respondents (60%) find the transportation frequency insufficient, with younger age groups (18-25) reporting higher dissatisfaction. To improve, implementing direct bus routes, real-time tracking apps, and modernizing buses could enhance accessibility and user experience. An interesting fact: despite La Magdalena Contreras being the closest alcaldía, 50% of respondents still report inefficient routes, possibly due to poor coverage within the alcaldía itself.
            </p>
          </section>
        </div>
      );
    };

    // Rendering the app using createRoot
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Dashboard />);
  </script>
</body>
</html>
